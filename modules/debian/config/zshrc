# === ENVIRONMENT ===
export PATH="$HOME/.local/bin:$PATH"
export EDITOR="nvim"
export PAGER="less"

# === PROMPT ===
eval "$(starship init zsh)"

# === HISTORY ===
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt HIST_IGNORE_DUPS
setopt SHARE_HISTORY
setopt INC_APPEND_HISTORY

# === COMPLETION ===
autoload -Uz compinit
compinit -d ~/.zsh_compdump

# === Git Completion ===
# Use system-provided or manually installed fallback
if [ -f /usr/share/zsh/site-functions/git-completion.zsh ]; then
  source /usr/share/zsh/site-functions/git-completion.zsh
elif [ -f ~/.zsh/completions/git-completion.bash ]; then
  autoload -Uz +X bashcompinit && bashcompinit
  source ~/.zsh/completions/git-completion.bash
fi

# === Kubectl Completion ===
if command -v kubectl >/dev/null; then
  source <(kubectl completion zsh)
fi

# === Alias-aware Completion ===
alias k='kubectl'
compdef k=kubectl


# === FZF-TAB (smart <Tab> menu with previews) ===
[[ -f ~/.zsh/plugins/fzf-tab/fzf-tab.plugin.zsh ]] && source ~/.zsh/plugins/fzf-tab/fzf-tab.plugin.zsh

# Global preview: works for any file path completion
zstyle ':completion:*' fzf-preview \
  '[[ -f "$realpath" ]] && bat --style=numbers --color=always "$realpath" 2>/dev/null || ls -lh "$realpath"'

# Fancy UI
zstyle ':fzf-tab:*' fzf-preview-window down:wrap
zstyle ':fzf-tab:*' single-group on

# === FZF (fuzzy search like fish shell) ===
if command -v fzf >/dev/null; then
  export FZF_DEFAULT_COMMAND='fd --type f'
  export FZF_DEFAULT_OPTS="--height=40% --layout=reverse --border --preview 'bat --style=numbers --color=always {} 2>/dev/null'"
fi

# === AUTOSUGGESTIONS (Fish-like ghost text) ===
[[ -f ~/.zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh ]] && source ~/.zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh

# === SYNTAX HIGHLIGHTING ===
[[ -f ~/.zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]] && source ~/.zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

# === KEYBINDINGS ===
bindkey -e                              # Emacs-style editing
bindkey '^R' history-incremental-search-backward

# Fish-style history navigation by prefix
autoload -Uz up-line-or-beginning-search down-line-or-beginning-search
zle -N up-line-or-beginning-search
zle -N down-line-or-beginning-search
bindkey '^P' up-line-or-beginning-search
bindkey '^N' down-line-or-beginning-search

# === ALIASES (eza preferred over ls) ===
if command -v eza >/dev/null; then
  alias ls='eza'
  alias ll='eza -al --group-directories-first'
  alias la='eza -a'
  alias l='eza -l'
  alias lt='eza --tree'
else
  alias ls='ls --color=auto'
  alias ll='ls -alF'
  alias la='ls -A'
  alias l='ls -CF'
fi

alias g='git'
alias v='nvim'

# === TITLE BAR (optional) ===
precmd() { print -Pn "\e]0;%n@%m: %~\a" }

# === LOCAL OVERRIDES ===
[[ -f ~/.zshrc.local ]] && source ~/.zshrc.local
